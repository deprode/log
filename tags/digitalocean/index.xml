<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
      <title>Digitalocean on log </title>
      <generator uri="https://gohugo.io">Hugo</generator>
    <link>http://log.deprode.net/tags/digitalocean/index.xml</link>
    
    
    <copyright>deprode</copyright>
    <updated>Mon, 01 Jan 0001 00:00:00 UTC</updated>
    
    <item>
      <title>2015 05 05</title>
      <link>http://log.deprode.net/logs/2015-05-05/</link>
      <pubDate>Tue, 05 May 2015 23:57:08 JST</pubDate>
      
      <guid>http://log.deprode.net/logs/2015-05-05/</guid>
      <description>&lt;ul&gt;
&lt;li&gt;VagrantでDigitalOceanを立ち上げるのとProvisionを別にした方が良さそうな気がしてきた。

&lt;ul&gt;
&lt;li&gt;要するに、rootパスワード変更、sshポート変更、iptables設定、yum update、などを最初にやる必要があるのだが、これをやると接続ポートを変更する必要があるため、次回以降接続するために設定を変更する必要がある。

&lt;ul&gt;
&lt;li&gt;また、rootパスワード変更は手動でやった方がいい気がする。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;なので、provisionは別でansibleで行うことにした。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Vagrant-DigitalOceanやろうと思ったら、&lt;code&gt;An active machine was found with a different provider.&lt;/code&gt;エラー。

&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.vagrant&lt;/code&gt;フォルダを削除するといいらしい。

&lt;ul&gt;
&lt;li&gt;ということは、Develop用とProvision用の2つのVagrantFileが必要になるってことなのかな。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;DigitalOceanは最近cliend-id&amp;amp;api-key方式からapi-token方式に切り替わったので、過去の資料（の一部）が役に立たなくなってるなどがあった。&lt;/li&gt;
&lt;li&gt;しょうがないので、DigitalOceanテスト用にVagrantFile作る

&lt;ul&gt;
&lt;li&gt;参考→&lt;a href=&#34;http://blog.morizotter.com/2015/01/05/create-instant-server-instance-with-vagrantdigitalocean/&#34;&gt;Vagrant+DigitalOceanで使い捨て即席サーバを作成する | Morizotter Blog&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;hostsファイル書いてなくてprovision失敗したけど、サーバは起動した。やった。₍₍ (ง &amp;lsquo;ω&amp;rsquo;)ว ⁾⁾

&lt;ul&gt;
&lt;li&gt;vagrant sshでrootログインできた。&lt;/li&gt;
&lt;li&gt;sshのport変えたらログインできなくなった

&lt;ul&gt;
&lt;li&gt;config.ssh.portを設定して再度vagrant up&lt;/li&gt;
&lt;li&gt;sshはssh-configを~/.ssh/configに書いたので接続できるけど、vagrant sshが読み込まれてない&lt;/li&gt;
&lt;li&gt;普通にansibleコマンドも使える。ので、vagrant sshのssh-configを再読込できれば問題ないことになる。&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://girigiribauer.com/archives/1749&#34;&gt;Vagrant で SSH の接続ポート番号を変える、という発想がそもそも間違ってた | girigiribauer.com&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;終わり。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;要は、Vagrantは同一環境の仮想環境を起動するところまでが役割だからSSHポート変更したらvagrant sshで接続できなくなってもかまわないってことなのかな……。

&lt;ul&gt;
&lt;li&gt;いや、普通はvagrant reloadとかで直った気がする。providerがあることでどうのこうの。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;とりあえずansibleだけでやる。

&lt;ul&gt;
&lt;li&gt;ERROR: &lt;code&gt;InnoDB: Cannot allocate memory for the buffer pool&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;メモリが足りてなかった。（Swap領域がなかったのでダメだったっぽい。）

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://nekopunch.hatenablog.com/entry/2014/03/22/020507&#34;&gt;Vagrant+VirtualBox+CentOS環境でMySQL5.6が起動しない場合の対処法 - 憂鬱な世界にネコパンチ！&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;あとでtagつけて切り替えられるようにしたい。&lt;/li&gt;
&lt;li&gt;ntpdateでcommand実行してるので、常にchangedになるけど、okにする方法がわからない。ansible力が足りない。&lt;/li&gt;
&lt;li&gt;fileモジュールでstate=touchにすると常にchangedになるんだけど、okにする方法がわからない。( ˘ω˘)&lt;/li&gt;
&lt;li&gt;とりあえずfailed=0になったのでよかった。（˶˘◡˘˶）&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;で、このあとiptablesとsshdの設定を別のplaybookでやった。

&lt;ul&gt;
&lt;li&gt;一部は手動。sshdのファイル設定。&lt;/li&gt;
&lt;li&gt;で、ここでrootのログインを禁止した後に作業ユーザーのパスワードをちゃんと設定できていないことが判明し、詰んだので作り直す。

&lt;ul&gt;
&lt;li&gt;失敗できるやつでよかった。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;python -c &#39;import crypt; print crypt.crypt(&amp;quot;password&amp;quot;, &amp;quot;$1$SomeSalt$&amp;quot;)&#39;&lt;/code&gt;でpasswordを暗号化してansibleで使えるようになるのだが、環境によって違うっぽい。MacだとSaltがない13桁の文字列になる。

&lt;ul&gt;
&lt;li&gt;というか、公式にもOS Xだとアレだからって書いてあった。&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://docs.ansible.com/faq.html#how-do-i-generate-crypted-passwords-for-the-user-module&#34;&gt;Frequently Asked Questions — Ansible Documentation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://stackoverflow.com/questions/15231661/how-do-i-create-a-user-and-set-a-password-using-ansible/17992126#17992126&#34;&gt;cryptography - How do I create a user and set a password using ansible? - Stack Overflow&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;とりあえず、CentOSで暗号化して、何とかなった。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;iptablesでsshポートを変えたがsshポートの設定を変える処理忘れてた。

&lt;ul&gt;
&lt;li&gt;管理画面からrootでログインしてsshのポート変えて設定読み直して事なきを得た。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;とりあえず何とかなってるので、よかった。もう寝る。

&lt;ul&gt;
&lt;li&gt;メモリとか見ると心許ない。今のところ大丈夫だけど、落ちるようなら……。&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;
</description>
    </item>
    
  </channel>
</rss>